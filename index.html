<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emission Data</title>
    <link rel="stylesheet" href="style.css">
    <!--https://www.w3schools.com/html/html_css.asp-->
    <!--https://stackoverflow.com/questions/39476292/align-select-boxes-and-text-boxes-->
</head>

<body>

    <div class="container">

        <div id="heading">
            <h1 id="title">Emission Data</h1>
            <p id="subtitle">Use the interactive charts below to explore the dataset</p>
        </div>

        <div class="dropdown">
            <p class="dropdown-title">Country</p>
            <select id="selCountry" class="selDataset" onchange="optionChanged(this.value)"></select>
        </div>

        <div class="dropdown">
            <p class="dropdown-title">Year</p>
            <select id="selYear" class="selDataset" onchange="optionChanged(this.value)"></select>
        </div>

        <div id="info">
            <p class="dropdown-title">Total Emissions</p>
            <p class="total-emissions"></p>
            <p class="dropdown-subtitle">MtCO2</p>
        </div>

        <div id="scatter"></div>

        <div id="pie"></div>

        <div id="bubble"></div>

    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>

        //Function to build charts
        function buildCharts() {
            d3.json("data.json").then(function(data) {
                console.log(data);

                let emissionData = data.emissions;
                let gdpData = data.gdp;
                let populationData = data.population;
                let countryData = data.countries

                let selectedYear = d3.select("#selYear").property("value");
                let selectedCountry = d3.select("#selCountry").property("value");

                //Pie Chart
                let pieLabels = ["Cement", "Coal", "Flaring", "Gas", "Oil", "Other"]
                let pieData = []

                for (let i=0; i<emissionData.length; i++) {
                    if (emissionData[i].Country == selectedCountry & emissionData[i].Year == selectedYear) {
                        pieData.push(emissionData[i].Total);
                        pieData.push(emissionData[i].Cement);
                        pieData.push(emissionData[i].Coal);
                        pieData.push(emissionData[i].Flaring);
                        pieData.push(emissionData[i].Gas);
                        pieData.push(emissionData[i].Oil);
                        pieData.push(emissionData[i].Other);
                    }
                };

                d3.select("#pie").html("");

                if (pieData[0] == undefined | pieData[0] == 0) {
                    //https://stackoverflow.com/questions/6840326/how-can-i-create-and-style-a-div-using-javascript
                    let pieDiv = document.createElement("div");
                    pieDiv.innerHTML = "Data Unavailable";
                    pieDiv.setAttribute("class", "plot-text");
                    pie.appendChild(pieDiv);

                    d3.select(".total-emissions").text("N/A");
                }
                else {
                    let trace1 = {
                    values : pieData.slice(1,6),
                    labels : pieLabels,
                    type : "pie"
                    };

                    let trace1data = [trace1];

                    let layout1 = {
                        title : `Emissions in ${selectedYear}`
                    };

                    //https://plotly.com/javascript/pie-charts/
                    Plotly.newPlot("pie", trace1data, layout1);

                    d3.select(".total-emissions").text(pieData[0]);
                }

                //Scatter Graph
                emissions = []
                years =[]

                for (let i=0; i<emissionData.length; i++) {
                    if (emissionData[i].Country == selectedCountry) {
                        emissions.push(emissionData[i].Total);
                        years.push(emissionData[i].Year);
                    }
                };
                
                let trace2 = {
                    x : years,
                    y : emissions,
                    type : "scatter",
                    mode : "markers"
                };

                let layout2 = {
                    title : "Total Emissions Over The Last 100 Years",
                    xaxis : {
                        title : "Year"
                    },
                    yaxis : {
                        title : "Total Emissions (MtCO2)"
                    }
                };

                let trace2Data = [trace2];

                Plotly.newPlot("scatter", trace2Data, layout2);

                //Bubble Chart
                gdps = [];
                populations = [];
                countries = [];
                continents = [];
                emissions = [];

                //https://stackoverflow.com/questions/29888256/using-integer-keys-with-dot-notation-to-access-property-in-javascript-objects
                for (let i=0; i<countryData.length; i++) {

                    let country = countryData[i].Country;

                    gdps.push(gdpData[i]["2020"]);
                    populations.push(populationData[i]["2020 Population"]);
                    countries.push(country);
                    continents.push(countryData[i].Continent);

                    for (let j=0; j<emissionData.length; j++) {
                        if (emissionData[j].Country == country & emissionData[j].Year == 2020) {
                        emissions.push(Math.sqrt(emissionData[j].Total));
                        }
                    };
                };

                //function findRow(row) {
                //return row.Year == 2020
                //};

                //let emissionsRow = emissionData.filter(findRow);
                //console.log(emissionsRow);

                let colors = []

                for (let i=0; i<continents.length; i++) {
                    
                    let color = ""

                    if ((continents[i] == "Asia") | (continents[i] == "Oceania")) {
                        color = "red";
                    } else if (continents[i] == "Europe") {
                        color = "yellow"
                    } else if (continents[i] == "Africa") {
                        color = "blue";
                    } else { 
                        color = "green";
                    }

                    colors.push(color);
                
                };

                let trace3 = {
                    x : populations,
                    y : gdps,
                    type : "scatter",
                    mode : "markers",
                    marker : {
                        size : emissions,
                        color : colors
                    },
                    text : emissions
                };

                let layout3 = {
                    xaxis : {
                        title : "Population",
                    },
                    yaxis : {
                        title : "GDP ($)"
                    },
            
                };

                let trace3Data = [trace3];

                Plotly.newPlot("bubble", trace3Data, layout3);

            });

        }
    
        //Function to initialise dashboard
        function init() {
            d3.json("data.json").then(function(data) {

                let countries = data.countries
                let countryDropdown = d3.select("#selCountry");

                for (let i=0; i<countries.length; i++) {
                    countryDropdown.append("option").text(countries[i].Country);
                };

                selectedCountry = countryDropdown.property("value");

                years = []

                for (let i=1921; i<=2021; i++) {
                    years.push([i]);
                };
                
                let yearDropdown = d3.select("#selYear");
                for (let i=0; i<years.length; i++) {
                    yearDropdown.append("option").text(years[i]);
                };

                selectedYear = yearDropdown.property("value");

                buildCharts();
            });
        }

        //Function on option change
        function optionChanged() {
            d3.json("data.json").then(function(data) {

                buildCharts();
            });
        }

        //Initialise dashboard
        init();

    </script>

</body>

</html>