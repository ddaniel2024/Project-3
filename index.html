<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Emission Data</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">

        <div id="heading">
            <h1>CO2 Emission Data</h1>
            <p>Use the interactive charts below to explore the dataset</p>
        </div>

        <div class="info">

            <div class="subheading">
                <h3>Global CO2 Emissions</h3>
            </div>

            <div id="bubble-year">
                <p class="panel-title">Year</p>
                <select id="sel-bubble-year" class="sel-dataset" onchange="optionChanged(this.value)"></select>
            </div>

            <div id="bubble-plot"></div>

            <div id="bar-selectors">
                <div id="bar-year">
                    <p class="panel-title">Year</p>
                    <select id="sel-bar-year" class="sel-dataset" onchange="optionChanged(this.value)"></select>
                </div>
                <div id="bar-emission">
                    <p class="panel-title">Emission Type</p>
                    <select id="sel-bar-emission" class="sel-dataset" onchange="optionChanged(this.value)"></select>
                </div>
            </div>

            <div id="bar"></div>

        </div>

        <div class="info">

            <div class="subheading">
                <h3>Country-focused CO2 Emissions</h3>
            </div>

            <div class="panel">
                <p class="panel-title">Country</p>
                <select id="sel-global-country" class="sel-dataset" onchange="optionChanged(this.value)"></select>
            </div>

            <div class="panel">
                <p class="panel-title">Year</p>
                <select id="sel-global-year" class="sel-dataset" onchange="optionChanged(this.value)"></select>
            </div>

            <div class="panel">
                <p class="panel-title">Total Emissions</p>
                <p id="emissions-panel-info"></p>
                <p class="panel-subtitle">MtCO2</p>
            </div>

            <div id="line"></div>

            <div id="pie"></div>
        </div>

    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>

        //Function to build charts
        function buildCharts() {
            d3.json("output/data.json").then(function(data) {
                console.log(data);

                //Retrieve data from json
                let emissionData = data.emissions;
                let gdpData = data.gdp;
                let populationData = data.population;
                let countryData = data.countries

                let selectedBubbleYear = d3.select("#sel-bubble-year").property("value");
                let selectedBarYear = d3.select("#sel-bar-year").property("value");
                let selectedBarEmission = d3.select("#sel-bar-emission").property("value");

                let selectedCountry = d3.select("#sel-global-country").property("value");
                let selectedYear = d3.select("#sel-global-year").property("value");

                //Bubble Chart
                //Establish empty arrays for bubble chart
                gdps = [];
                populations = [];
                countries = [];
                continents = [];
                emissions = [];

                //Populate arrays with a "for" loop
                for (let i=0; i<countryData.length; i++) {

                    let country = countryData[i].Country;

                    gdps.push(gdpData[i][selectedBubbleYear]);
                    populations.push(populationData[i][`${selectedBubbleYear} Population`]);
                    countries.push(country);
                    continents.push(countryData[i].Continent);

                    for (let j=0; j<emissionData.length; j++) {
                        if (emissionData[j].Country == country & emissionData[j].Year == selectedBubbleYear) {
                        emissions.push(Math.sqrt(emissionData[j].Total));
                        }
                    };
                };

                //Get color using the "continents" array
                colors = []

                for (let i=0; i<continents.length; i++) {
                    
                    let color = ""

                    if ((continents[i] == "Asia") | (continents[i] == "Oceania")) {
                        color = "red";
                    } else if (continents[i] == "Europe") {
                        color = "yellow"
                    } else if (continents[i] == "Africa") {
                        color = "blue";
                    } else { 
                        color = "green";
                    }

                    colors.push(color);
                
                };

                //Generate bubble chart
                let bubbleTrace = {
                    x : populations,
                    y : gdps,
                    type : "scatter",
                    mode : "markers",
                    marker : {
                        size : emissions,
                        color : colors
                    },
                    hovertemplate : "<i>%{text}</i>" +
                                    "<br>" +
                                    "Population: %{x}" +
                                    "<br>" +
                                    "GDP: %{y}",
                    text : countries
                };

                let bubbleLayout = {
                    xaxis : {
                        title : "Population",
                    },
                    yaxis : {
                        title : "GDP ($)"
                    },
            
                };

                bubbleTraceData = [bubbleTrace];

                Plotly.newPlot("bubble-plot", bubbleTraceData, bubbleLayout);

                //Barplot
                //Use a function to find the rows of data that match the selected year
                function findYear(row) {
                return (row.Year == selectedBarYear)
                };

                //Filter, sort, and slice the data to obtain a "Top 10" array
                let emissionsRow = emissionData.filter(findYear);

                let sortedEmissionsRow = emissionsRow.sort((a,b) => b[selectedBarEmission] - a[selectedBarEmission]);

                let sliedEmissionsRow = sortedEmissionsRow.slice(0,10);

                //Clear selected section of any previous data
                d3.select("#bar").html("");

                //Generate barplot
                //Conditional: if there is no data availalbe, an error message is displayed; if not, the data is displayed
                if (sliedEmissionsRow == 0) {
                    //A new div is created to display the error message
                    let barDiv = document.createElement("div");
                    barDiv.innerHTML = "Data Unavailable";
                    barDiv.setAttribute("class", "plot-text");
                    bar.appendChild(barDiv);

                }
                else {
                    //Generate bar chart           
                    let barTrace = {
                        x : sliedEmissionsRow.map(object => object.Country),
                        y : sliedEmissionsRow.map(object => object[selectedBarEmission]),
                        type : "bar"
                    };
                    
                    let barTraceData = [barTrace];

                    let barLayout = {
                        title : `Top 10 ${selectedBarEmission} Emissions in ${selectedBarYear}`,
                        yaxis : {
                            title : "MTCO2"
                        }
                    };

                    Plotly.newPlot("bar", barTraceData, barLayout);
                }

                //Line Graph
                //Use a function to find the rows of data that match the selected country
                function findCountry(row) {
                return (row.Country == selectedCountry)
                };

                let lineDataArray = emissionData.filter(findCountry);

                //Generate line graph
                let lineTrace = {
                    x : lineDataArray.map(object => object.Year),
                    y : lineDataArray.map(object => object.Total),
                    type : "scatter",
                    mode : "line"
                };

                let lineLayout = {
                    title : "Total Emissions Over The Last 100 Years",
                    xaxis : {
                        title : "Year"
                    },
                    yaxis : {
                        title : "Total Emissions (MtCO2)"
                    }
                };

                lineData = [lineTrace];

                Plotly.newPlot("line", lineData, lineLayout);

                //Pie Chart
                //Establish an array for emission types (labels), and an blank array for the data
                pieLabels = ["Cement", "Coal", "Flaring", "Gas", "Oil", "Other"]
                pieData = []

                //Populate the blank array with a "for" loop
                for (let i=0; i<emissionData.length; i++) {
                    if (emissionData[i].Country == selectedCountry & emissionData[i].Year == selectedYear) {
                        pieData.push(emissionData[i].Total);
                        pieData.push(emissionData[i].Cement);
                        pieData.push(emissionData[i].Coal);
                        pieData.push(emissionData[i].Flaring);
                        pieData.push(emissionData[i].Gas);
                        pieData.push(emissionData[i].Oil);
                        pieData.push(emissionData[i].Other);
                    }
                };

                //Clear selected section of any previous data
                d3.select("#pie").html("");

                //Conditional: if there is no data availalbe, an error message is displayed; if not, the data is displayed
                if (pieData[0] == undefined | pieData[0] == 0) {
                    //A new div is created to display the error message
                    let pieDiv = document.createElement("div");
                    pieDiv.innerHTML = "Data Unavailable";
                    pieDiv.setAttribute("class", "plot-text");
                    pie.appendChild(pieDiv);

                    //Error message is also displayed on the emissions info panel
                    d3.select("#emissions-panel-info").text("N/A");
                }
                else {
                    //Generate pie chart
                    let pieTrace = {
                    values : pieData.slice(1,6),
                    labels : pieLabels,
                    type : "pie"
                    };

                    let pieTraceData = [pieTrace];

                    let pieLayout = {
                        title : `Emissions in ${selectedYear}`
                    };

                    Plotly.newPlot("pie", pieTraceData, pieLayout);

                    //Data is also displayed on the emissions info panel
                    d3.select("#emissions-panel-info").text(pieData[0]);
                }
            });
        }
    
        //Function to initialise dashboard
        function init() {
            d3.json("output/data.json").then(function(data) {

                //Appened options for country-focused dropdown (country)
                let countries = data.countries;

                let countryDropdown = d3.select("#sel-global-country");

                for (let i=0; i<countries.length; i++) {
                    countryDropdown.append("option").text(countries[i].Country);
                };

                let selectedCountry = countryDropdown.property("value");

                //Appened options for country-focused dropdown (years)
                years = []

                for (let i=1921; i<=2021; i++) {
                    years.push([i]);
                };

                let yearDropdown = d3.select("#sel-global-year");

                for (let i=0; i<years.length; i++) {
                    yearDropdown.append("option").text(years[i]);
                };

                let selectedYear = yearDropdown.property("value");

                //Appened options for bubbleplot years
                bubbleYears = [1970, 1980, 1990, 2000, 2010, 2020];

                let bubbleYearDropdown = d3.select("#sel-bubble-year");
                
                for (let i=0; i<bubbleYears.length; i++) {
                    bubbleYearDropdown.append("option").text(bubbleYears[i]);
                };

                let selectedBubbleYear = bubbleYearDropdown.property("value");

                //Appened options for barplot emissions
                barEmissions = ["Cement", "Coal", "Flaring", "Gas", "Oil", "Other", "Total"];

                let barEmissionDropdown = d3.select("#sel-bar-emission");

                for (let i=0; i<barEmissions.length; i++) {
                    barEmissionDropdown.append("option").text(barEmissions[i]);
                };

                let selectedBarEmission = barEmissionDropdown.property("value");

                //Appened options for barplot years
                let barYearDropdown = d3.select("#sel-bar-year");

                for (let i=0; i<years.length; i++) {
                    barYearDropdown.append("option").text(years[i]);
                };

                let selectedBarYear = barYearDropdown.property("value");

                buildCharts();
            });
        }

        //Function on option change
        function optionChanged() {
            d3.json("output/data.json").then(function(data) {

                buildCharts();
            });
        }

        //Initialise dashboard
        init();

    </script>

</body>

</html>